{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
</head>
<body>
    <div id="map" style="width: 500px; height: 400px;"></div>
    <ul>
    {% for point in points %}
        <li>{{ point.lat }}, {{ point.lon }}</li>
    {% endfor %}
    </ul>
    <button onclick="submit();">Submit</button>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>
    {% csrf_token %}
    <script>
        window.onload = function() {
			var map = L.map('map').setView([52.242640699999995, 6.853709299999999], 14);
			L.tileLayer('http://tile.thunderforest.com/transport/{z}/{x}/{y}.png', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
				maxZoom: 18,
				id: 'base',
			}).addTo(map);

			{% for point in points %}
				var marker = L.marker([{{ point.lat }}, {{ point.lon }}])
                    .addTo(map);
			{% endfor %}
		};

        function submit() {
			window.navigator.geolocation.getCurrentPosition(send_location);
        }

        function send_location(position) {
			coords = position.coords;
			var xhr = new XMLHttpRequest();
			xhr.open("POST", window.location.href, true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			xhr.setRequestHeader("X-CSRFToken", document.querySelector("[name=csrfmiddlewaretoken]").value);
			xhr.send(JSON.stringify({
				lat: coords.latitude,
				lng: coords.longitude,
			}));
			window.location.reload();
        }
    </script>
</body>
</html>